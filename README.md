# explainable_ros

This repository provides a ROS 2 package for generating explanations in autonomous robots based on log analysis using LLMs.

Explainable_ros uses the RAG method to filter the most relevant logs from those generated by the robot during the execution of its behavior.

To enhance the robot's internal data, a VLM is used to process the images captured by the onboard camera, describe them, and log them through rosout. This allows the combination of logs generated by the robot subsystems with images of the environment. The workflow of the system is illustrated in the following figure:

![](./images/figures/Workflow.png)

On the other hand, the high-level representation of the components that make up the developed system is shown in the following figure.

<p align="center">
  <img src="./images/figures/ArchExplicability.png" />
</p>

## Table of Contents

1. [Installation](#installation)
2. [Usage](#usage)
3. [Demos](#demos)
   - [LLM](#llm)
4. [Related Works](#related-works)
   - [Other Software Projects](#other-software-projects)
   - [Related Datasets](#related-datasets)
   - [Papers](#papers)
5. [Cite](#cite)
6. [Acknowledgments](#acknowledgments)

## Installation

To run llama_ros with CUDA, first, you must install the [CUDA Toolkit](https://developer.nvidia.com/cuda-toolkit). Then, you can continue with the installation.

```shell
cd ~/ros2_ws/src
git clone https://github.com/mgonzs13/llama_ros.git
git clone https://github.com/Dsobh/explainable_ros.git
pip3 install -r llama_ros/requirements.txt
cd ~/ros2_ws
rosdep install --from-paths src --ignore-src -r -y
colcon build --cmake-args -DGGML_CUDA=ON # add this for CUDA
```

<!-- ### Docker [WIP]

You can also use docker. To do this you can compile the dockerfile found in the root of this repository or download the corresponding image from Dockerhub.

Run container:

```shell
sudo docker run --rm -it --entrypoint bash <docker_name:tag>
```

Run second container:

```shell
docker exec -it <container_id> bash
``` -->

## Usage

- Run the launch file with the emebedding, reranker and LLM models:

```shell
ros2 launch explainable_ros_bringup explainable_ros.launch.py
```

The explainable node subscribes to the rosout topic and process the logs to add them to the context of the LLM. You can play a rosbag file in order to generate logs and test the operation of the system.

- To request a explanation you should use the /question service:

```shell
ros2 service call /question explainable_ros_msgs/srv/Question "{'question': 'What is happening?'}"
```

Or you can use the explainability client:

```shell
ros2 run explainable_ros explainability_client_node "What is happening?"
```

## Demos

### LLM

For the examples shown in this section we use the following models (available in llama_ros repository):

- _Embbeding model_: bge-base-en-v1.5.yaml
- _Reranker model_: jina-reranker
- _Base model_: Qwen2

First of all, download the [bags](https://doi.org/10.5281/zenodo.10518775). Then, launch the explainable_ros bringup:

```shell
ros2 launch explainable_ros_bringup explainable_ros.launch.py
```

Then, play one of the bags, for example, bag 4:

```shell
ros2 bag play Prueba4
```

Finally, wait till all logs are processed and stored and you can ask questions:

```shell
ros2 run explainable_ros_demos explainable_demo_node
```

#### Results

Here you have the results for each bag using specific questions from demo.

##### Prueba 4

<details>
<summary>Click to expand</summary>

| **User Question**                                                       | **LLM Answer**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ----------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| How many waypoints were received during the navigation task?            | Based on the logs provided, the robot received a total of 3 waypoints during the navigation task. These waypoints were identified by their IDs: 9, 6, and 7.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| What were the IDs of the waypoints received during the navigation task? | The IDs of the waypoints received during the navigation task were 9, 6, and 7.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| Were all the waypoints received successfully reached?                   | Yes, all the waypoints received were successfully reached. The logs indicate that the robot received waypoints with IDs 9, 6, and 7, and after reaching each waypoint, it continued to wait for a new one. The final log entry states that "All the waypoints received have been reached. Navigation task completed," confirming that the robot successfully navigated to all the waypoints.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| What happened during navigation to waypoint with ID 6?                  | During the navigation to waypoint with ID 6, the robot encountered an obstacle. The distance to the point increased from 5.78 meters to 14.65 meters, indicating that the robot had to adjust its path to avoid the obstacle. Despite the obstacle, the robot successfully navigated to the waypoint with ID 6.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Why was the route replanned during navigation to waypoint with ID 6?    | The route was replanned during navigation to waypoint with ID 6 because an obstacle was detected. The logs indicate that the robot initially started navigating to waypoint 6, but as it approached, it detected an obstacle, causing the distance to the point to increase significantly from 5.78 meters to 14.65 meters. This obstacle detection triggered the robot to replan its route to avoid the obstacle and continue its navigation to the intended waypoint. Once the obstacle was avoided, the robot successfully navigated to waypoint 6.                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Have any relevant events occurred during navigation?                    | Yes, relevant events have occurred during navigation. Specifically, the robot encountered obstacles while navigating to certain waypoints. Here are the details: 1. **Obstacle Detected during Navigation to Waypoint with ID: 6**: - The robot started navigating from (7.51, 5.03) to (1.55, 4.03). - An obstacle was detected, causing the distance to the point to increase from 5.78 meters to 14.65 meters. - Despite the obstacle, the robot successfully navigated to the waypoint with ID: 6. 2. **Obstacle Detected during Navigation to Waypoint with ID: 7**: - The robot started navigating from (1.50, 3.82) to (4.89, 1.64). - An obstacle was detected, causing the distance to the point to increase from 0.15 meters to 0.21 meters. - Despite the obstacle, the robot successfully navigated to the waypoint with ID: 7. These events indicate that the robot's navigation system is functioning as intended, as it is able to detect obstacles and continue navigating to the next waypoint. |
| What is the task that the robot had to perform?                         | Based on the logs provided, it appears that the robot was performing a task involving multiple goal points or waypoints. The logs indicate that the robot received multiple goals, computed control effort for each, and successfully reached each goal. The robot also seems to be waiting for a new waypoint after reaching a goal, suggesting that it is following a sequence of waypoints or goals.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| Did the robot avoid any obstacle during the navigation?                 | Yes, the robot avoided obstacles during the navigation. The logs indicate that the robot detected obstacles and successfully navigated around them. Specifically: 1. **Waypoint ID: 6** - The robot detected an obstacle and increased the distance to the point from 5.78 meters to 14.65 meters before successfully reaching the waypoint. 2. **Waypoint ID: 7** - The robot detected a smaller obstacle and increased the distance to the point from 0.15 meters to 0.21 meters before successfully reaching the waypoint. These observations show that the robot's navigation system was able to detect obstacles and adjust its path accordingly, ensuring that it avoided them during the navigation process.                                                                                                                                                                                                                                                                                              |

</details>

## Related Works

### Other Software Projects

- [llama_ros](https://github.com/mgonzs13/llama_ros) → A repository that provides a set of ROS 2 packages to integrate llama.cpp into ROS 2.

### Related Datasets

A series of rosbags (ROS 2 Humble) published in Zenodo are listed below. This data can be used to test the explainability capabilities of the project.

- Sobrín Hidalgo, D. (2024). Navigation Benchmark Rosbags Inspired by ERL Competition Test (1.0.0) [Data set]. Robotics Group. https://doi.org/10.5281/zenodo.10518775

- Sobrín Hidalgo, D. (2024). Navigation Test in Simulated Environment Rosbag. Human obstacle detection. (1.0.0) [Data set]. Robotics Group. https://doi.org/10.5281/zenodo.10896141

### Papers

- Sobrín-Hidalgo, D., González-Santamarta, M. A., Guerrero-Higueras, Á. M., Rodríguez-Lera, F. J., & Matellán-Olivera, V. (2024). [Explaining Autonomy: Enhancing Human-Robot Interaction through Explanation Generation with Large Language Models](https://arxiv.org/abs/2402.04206). arXiv preprint arXiv:2402.04206.
- Sobrín-Hidalgo, D., González-Santamarta, M. Á., Guerrero-Higueras, Á. M., Rodríguez-Lera, F. J., & Matellán-Olivera, V. (2024). [Enhancing Robot Explanation Capabilities through Vision-Language Models: a Preliminary Study by Interpreting Visual Inputs for Improved Human-Robot Interaction](https://arxiv.org/abs/2404.09705). arXiv preprint arXiv:2404.09705.

## Cite

If your work uses this repository, please, cite the repository or the following paper:

```
@article{sobrin2024explaining,
  title={Explaining Autonomy: Enhancing Human-Robot Interaction through Explanation Generation with Large Language Models},
  author={Sobr{\'\i}n-Hidalgo, David and Gonz{\'a}lez-Santamarta, Miguel A and Guerrero-Higueras, {\'A}ngel M and Rodr{\'\i}guez-Lera, Francisco J and Matell{\'a}n-Olivera, Vicente},
  journal={arXiv preprint arXiv:2402.04206},
  year={2024}
}
```

## Acknowledgments

This project has been partially funded by the Recovery, Transformation, and Resilience Plan, financed by the European Union (Next Generation) thanks to the TESCAC project (Traceability and Explainability in Autonomous Cystems for improved Cybersecurity) granted by INCIBE to the University of León, and by grant PID2021-126592OB-C21 funded by MCIN/AEI/10.13039/501100011033 EDMAR (Explainable Decision Making in Autonomous Robots) project, PID2021-126592OB-C21 funded by MCIN/AEI/10.13039/501100011033 and by ERDF ”A way of making Europe”.

<img src="./images/logos/logo_demarce.png" width="150"/> <img src="./images/logos/logo_edmarce.png" width="140"/>

<img src="./images/logos/BandaLogos_INCIBE_page-0001.jpg" width="2000"/>
